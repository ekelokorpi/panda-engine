<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/engine/core.js - Panda.js</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../../media/logo_small2.png" title="Panda.js"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 1.0.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/Core.html">Core</a></li>
            
                <li><a href="../classes/System.html">System</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/game.html">game</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: src/engine/core.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
// Panda.js HTML5 game engine
// author Eemeli Kelokorpi

// inspired by Impact Game Engine
// sponsored by Yle

(function(window){ &#x27;use strict&#x27;;

/**
 * @module game
 */
/**
 * Automatically created at &#x60;game&#x60; and &#x60;game.core&#x60;
 * @class Core
 */
var core = {
    _current: null,
    _loadQueue: [],
    _waitForLoad: 0,
    _DOMLoaded: false,
    scene: null,
    debug: null,
    system: null,
    sound: null,
    pool: null,
    renderer: null,
    storage: null,
    window: window,
    modules: {},
    resources: [],
    audioResources: [],
    ready: false,
    baked: false, // ???
    nocache: &#x27;&#x27;,
    ua: {},
    /**
     * Scale factor for game engine. (Used in Retina and HiRes mode.)
     * @property {Number} scale
     */
    scale: 1,
        
    copy: function(object) {
        var l,c,i;
        if(
            !object || typeof(object) !== &#x27;object&#x27; ||
            object instanceof HTMLElement ||
            object instanceof game.Class
        ) {
            return object;
        }
        else if(object instanceof Array) {
            c = [];
            for(i = 0, l = object.length; i &lt; l; i++) {
                c[i] = game.copy(object[i]);
            }
            return c;
        }
        else {
            c = {};
            for(i in object) {
                c[i] = game.copy(object[i]);
            }
            return c;
        }
    },
    
    merge: function(original, extended) {
        for(var key in extended) {
            var ext = extended[key];
            if(
                typeof(ext) !== &#x27;object&#x27; ||
                ext instanceof HTMLElement ||
                ext instanceof game.Class
            ) {
                original[key] = ext;
            }
            else {
                if(!original[key] || typeof(original[key]) !== &#x27;object&#x27;) {
                    original[key] = (ext instanceof Array) ? [] : {};
                }
                game.merge(original[key], ext);
            }
        }
        return original;
    },
    
    ksort: function(obj) {
        if(!obj || typeof(obj) !== &#x27;object&#x27;) return false;
        
        var keys = [], result = {}, i;
        for(i in obj ) {
            keys.push(i);
        }
        keys.sort();
        for(i = 0; i &lt; keys.length; i++ ) {
            result[keys[i]] = obj[keys[i]];
        }
        
        return result;
    },

    setVendorAttribute: function(el, attr, val) {
        var uc = attr.ucfirst();
        el[attr] = el[&#x27;ms&#x27;+uc] = el[&#x27;moz&#x27;+uc] = el[&#x27;webkit&#x27;+uc] = el[&#x27;o&#x27;+uc] = val;
    },

    getVendorAttribute: function(el, attr) {
        var uc = attr.ucfirst();
        return el[attr] || el[&#x27;ms&#x27;+uc] || el[&#x27;moz&#x27;+uc] || el[&#x27;webkit&#x27;+uc] || el[&#x27;o&#x27;+uc];
    },

    normalizeVendorAttribute: function(el, attr) {
        var prefixedVal = this.getVendorAttribute(el, attr);
        el[attr] = el[attr] || prefixedVal;
    },

    /**
     * Add asset to preloader.
     * @method addAsset
     * @param {String} path
     */
    addAsset: function(path) {
        this.resources.push(path);
    },

    /**
     * Add sound to preloader.
     * @method addSound
     * @param {String} path
     * @param {String} [name]
     */
    addSound: function(path, name) {
        name = name || path;
        this.SoundCache[name] = new game.Sound(path);
    },

    /**
     * Add music to preloader.
     * @method addMusic
     * @param {String} path
     * @param {String} [name]
     */
    addMusic: function(path, name) {
        name = name || path;
        this.MusicCache[name] = new game.Music(path);
    },
    
    setNocache: function() {
        this.nocache = &#x27;?&#x27; + Date.now();
    },

    /**
     * Define new module.
     * @method module
     * @param {String} name
     * @param {String} [version]
     */
    module: function(name, version) {
        if(this._current) throw(&#x27;Module &#x27; + this._current.name + &#x27; has no body&#x27;);
        if(this.modules[name] &amp;&amp; this.modules[name].body) throw(&#x27;Module &#x27; + name + &#x27; is already defined&#x27;);
        
        this._current = {name: name, requires: [], loaded: false, body: null, version: version};
        this.modules[name] = this._current;
        this._loadQueue.push(this._current);
        return this;
    },

    /**
     * Require modules for module.
     * @method require
     * @param {Array} modules
     */
    require: function() {
        var i, modules = Array.prototype.slice.call(arguments);
        for (i = 0; i &lt; modules.length; i++) {
            if(modules[i]) this._current.requires.push(modules[i]);
        }
        return this;
    },

    /**
     * Define body for module.
     * @method body
     */
    body: function(body) {
        this._current.body = body;
        this._current = null;
        if(this._initDOMReady) this._initDOMReady();
    },
    
    _loadScript: function(name, requiredFrom) {
        this.modules[name] = true;
        this._waitForLoad++;
        
        var path = &#x27;src/&#x27; + name.replace(/\./g, &#x27;/&#x27;) + &#x27;.js&#x27; + this.nocache;
        var script = document.createElement(&#x27;script&#x27;);
        script.type = &#x27;text/javascript&#x27;;
        script.src = path;
        script.onload = function() {
            game._waitForLoad--;
            game._loadModules();
        };
        script.onerror = function() {
            throw(&#x27;Failed to load module &#x27; + name + &#x27; at &#x27; + path + &#x27; required from &#x27; + requiredFrom);
        };
        document.getElementsByTagName(&#x27;head&#x27;)[0].appendChild(script);
    },
    
    _loadModules: function() {
        var moduleLoaded, i, j, module, name, dependenciesLoaded;
        for(i = 0; i &lt; game._loadQueue.length; i++) {
            module = game._loadQueue[i];
            dependenciesLoaded = true;
            
            for(j = 0; j &lt; module.requires.length; j++) {
                name = module.requires[j];
                if(!game.modules[name]) {
                    dependenciesLoaded = false;
                    game._loadScript(name, module.name);
                }
                else if(!game.modules[name].loaded) {
                    dependenciesLoaded = false;
                }
            }
            
            if(dependenciesLoaded &amp;&amp; module.body) {
                game._loadQueue.splice(i, 1);
                module.loaded = true;
                module.body();
                moduleLoaded = true;
                i--;
            }
        }
        
        if(moduleLoaded &amp;&amp; this._loadQueue.length &gt; 0) {
            game._loadModules();
        }
        else if(!game.baked &amp;&amp; game._waitForLoad === 0 &amp;&amp; game._loadQueue.length !== 0) {
            var unresolved = [];
            for(i = 0; i &lt; game._loadQueue.length; i++ ) {
                var unloaded = [];
                var requires = game._loadQueue[i].requires;
                for(j = 0; j &lt; requires.length; j++ ) {
                    module = game.modules[requires[j]];
                    if(!module || !module.loaded) {
                        unloaded.push(requires[j]);
                    }
                }
                unresolved.push(game._loadQueue[i].name + &#x27; (requires: &#x27; + unloaded.join(&#x27;, &#x27;) + &#x27;)&#x27;);
            }
            throw(
                &#x27;Unresolved (circular?) dependencies. &#x27; +
                &#x27;Most likely there is a name/path mismatch for one of the listed modules:\n&#x27; +
                unresolved.join(&#x27;\n&#x27;)
            );
        }
    },
    
    _boot: function() {
        if(document.location.href.match(/\?nocache/)) this.setNocache();

        this.ua.pixelRatio = window.devicePixelRatio || 1;
        this.ua.screen = {
            width: window.screen.availWidth * this.ua.pixelRatio,
            height: window.screen.availHeight * this.ua.pixelRatio
        };
        
        this.ua.iPhone = /iPhone/i.test(navigator.userAgent);
        this.ua.iPhone4 = (this.ua.iPhone &amp;&amp; this.ua.pixelRatio === 2);
        this.ua.iPhone5 = (this.ua.iPhone &amp;&amp; this.ua.pixelRatio === 2 &amp;&amp; this.ua.screen.height === 1096);

        this.ua.iPad = /iPad/i.test(navigator.userAgent);
        this.ua.iPadRetina = (this.ua.iPad &amp;&amp; this.ua.pixelRatio === 2);
        
        this.ua.iOS = this.ua.iPhone || this.ua.iPad;
        this.ua.iOS5 = (this.ua.iOS &amp;&amp; /OS 5/i.test(navigator.userAgent));
        this.ua.iOS6 = (this.ua.iOS &amp;&amp; /OS 6/i.test(navigator.userAgent));
        this.ua.iOS7 = (this.ua.iOS &amp;&amp; /OS 7/i.test(navigator.userAgent));

        this.ua.android = /android/i.test(navigator.userAgent);
        this.ua.android2 = /android 2/i.test(navigator.userAgent);

        this.ua.wp = /Windows Phone/i.test(navigator.userAgent);
        this.ua.wp7 = (this.ua.wp &amp;&amp; /Windows Phone OS 7/i.test(navigator.userAgent));
        this.ua.wp8 = (this.ua.wp &amp;&amp; /Windows Phone 8/i.test(navigator.userAgent));
        this.ua.wpApp = (this.ua.wp &amp;&amp; typeof(window.external) !== &#x27;undefined&#x27; &amp;&amp; typeof(window.external.notify) !== &#x27;undefined&#x27;);

        this.ua.ie10 = /MSIE 10/i.test(navigator.userAgent);
        this.ua.ie11 = /rv:11.0/i.test(navigator.userAgent);
        
        this.ua.opera = /Opera/i.test(navigator.userAgent);
        this.ua.crosswalk = /Crosswalk/i.test(navigator.userAgent);

        this.ua.mobile = this.ua.iOS || this.ua.android || this.ua.wp;

        if(this.ua.wp) {
            if (typeof(window.external.notify) !== &#x27;undefined&#x27;) {
                window.console.log = function (message) {
                    window.external.notify(message);
                };
            }
        }
    },

    _DOMReady: function() {
        if(!game._DOMLoaded) {
            if(!document.body) return setTimeout(game._DOMReady, 13);
            game._DOMLoaded = true;
            game._loadModules();
        }
    },
    
    _initDOMReady: function() {
        this._initDOMReady = null;
        this._boot();
        if (document.readyState === &#x27;complete&#x27;) this._DOMReady();
        else {
            document.addEventListener(&#x27;DOMContentLoaded&#x27;, this._DOMReady, false);
            window.addEventListener(&#x27;load&#x27;, this._DOMReady, false);
        }
    }
};

window.game = core;
window.game.core = core;

Number.prototype.limit = function(min, max) {
    var i = this;
    if(i &lt; min) i = min;
    if(i &gt; max) i = max;
    return i;
};

Number.prototype.round = function(precision) {
    if(precision) precision = Math.pow(10, precision);
    else precision = 1;
    return Math.round(this * precision) / precision;
};

Array.prototype.erase = function(item) {
    for(var i = this.length; i--;) {
        if(this[i] === item) this.splice(i, 1);
    }
    return this;
};

Array.prototype.random = function() {
    return this[Math.floor(Math.random() * this.length)];
};

// http://jsperf.com/array-shuffle-comparator/2
Array.prototype.shuffle = function () {
    var l = this.length + 1;
    while (l--) {
            var r = ~~(Math.random() * l),
                    o = this[r];

            this[r] = this[0];
            this[0] = o;
    }

    return this;
};

// http://jsperf.com/function-bind-performance
Function.prototype.bind = function(context){
    var fn = this, linked = [];
    Array.prototype.push.apply(linked, arguments);
    linked.shift();

    return function(){
       var args = [];
       Array.prototype.push.apply(args, linked);
       Array.prototype.push.apply(args, arguments);
       return fn.apply(context, args);
    };
};

String.prototype.ucfirst = function() {
    return this.charAt(0).toUpperCase() + this.slice(1);
};

game.normalizeVendorAttribute(window, &#x27;requestAnimationFrame&#x27;);
if(window.requestAnimationFrame) {
    var next = 1, anims = {};

    window.game.setGameLoop = function(callback, element) {
        var current = next++;
        anims[current] = true;

        var animate = function() {
            if(!anims[current]) return;
            window.requestAnimationFrame(animate, element);
            callback();
        };
        window.requestAnimationFrame(animate, element);
        return current;
    };

    window.game.clearGameLoop = function(id) {
        delete anims[id];
    };
}
else {
    window.game.setGameLoop = function(callback) {
        return window.setInterval(callback, 1000/60);
    };
    window.game.clearGameLoop = function(id) {
        window.clearInterval(id);
    };
}

// http://ejohn.org/blog/simple-javascript-inheritance/
var initializing = false;
var fnTest = /xyz/.test(function(){ var xyz; return xyz; }) ? /\bparent\b/ : /[\D|\d]*/;

core.Class = function() {};
core.Class.extend = function(prop) {
    var parent = this.prototype;
    initializing = true;
    var prototype = new this();
    initializing = false;
 
    var makeFn = function(name, fn){
        return function() {
            var tmp = this.parent;
            this.parent = parent[name];
            var ret = fn.apply(this, arguments);
            this.parent = tmp;
            return ret;
        };
    };

    for(var name in prop) {
        if(
            typeof(prop[name]) === &#x27;function&#x27; &amp;&amp;
            typeof(parent[name]) === &#x27;function&#x27; &amp;&amp;
            fnTest.test(prop[name])
        ) {
            prototype[name] = makeFn(name, prop[name]);
        }
        else {
            prototype[name] = prop[name];
        }
    }
 
    function Class() {
        if(!initializing) {
            if(this.staticInit) {
                var obj = this.staticInit.apply(this, arguments);
                if(obj) {
                    return obj;
                }
            }
            for(var p in this) {
                if(typeof(this[p]) === &#x27;object&#x27;) {
                    this[p] = game.copy(this[p]); // deep copy!
                }
            }
            if(this.init) {
                this.init.apply(this, arguments);
            }
        }
        return this;
    }
    
    Class.prototype = prototype;
    Class.prototype.constructor = Class;
    Class.extend = window.game.Class.extend;
    Class.inject = function(prop) {
        var proto = this.prototype;
        var parent = {};

        var makeFn = function(name, fn){
            return function() {
                var tmp = this.parent;
                this.parent = parent[name];
                var ret = fn.apply(this, arguments);
                this.parent = tmp;
                return ret;
            };
        };

        for(var name in prop) {
            if(
                typeof(prop[name]) === &#x27;function&#x27; &amp;&amp;
                typeof(proto[name]) === &#x27;function&#x27; &amp;&amp;
                fnTest.test(prop[name])
            ) {
                parent[name] = proto[name];
                proto[name] = makeFn(name, prop[name]);
            }
            else {
                proto[name] = prop[name];
            }
        }
    };
    
    return Class;
};

})(window);

game.module(
    &#x27;engine.core&#x27;,
    &#x27;1.0.0&#x27;
)
.require(
    &#x27;engine.loader&#x27;,
    &#x27;engine.system&#x27;,
    &#x27;engine.sound&#x27;,
    &#x27;engine.renderer&#x27;,
    &#x27;engine.sprite&#x27;,
    &#x27;engine.debug&#x27;,
    &#x27;engine.storage&#x27;,
    &#x27;engine.tween&#x27;,
    &#x27;engine.pool&#x27;
)
.body(function(){ &#x27;use strict&#x27;;

game.start = function(scene, width, height, canvasId) {
    width = width || (game.System.orientation === game.System.PORTRAIT ? 768 : 1024);
    height = height || (game.System.orientation === game.System.PORTRAIT ? 927 : 671);

    game.system = new game.System(width, height, canvasId);
    game.sound = new game.SoundManager();
    game.pool = new game.Pool();
    if(game.Debug.enabled &amp;&amp; !navigator.isCocoonJS) game.debug = new game.Debug();
    if(game.Storage.id) game.storage = new game.Storage(game.Storage.id);

    game.ready = true;
    
    var loader = new game.Loader(scene || SceneTitle, game.resources, game.audioResources);
    loader.start();
};

});
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
